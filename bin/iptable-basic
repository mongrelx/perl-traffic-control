#!/usr/bin/perl 
use lib qw(/opt/perl-traffic-control/lib);
use PTC::Utils;

my $cfg_file=shift;

PTC::Utils::loadConfig($cfg_file);


print '# Generated by iptable-basic
*mangle
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
COMMIT
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:COUNTERS - [0:0]
:INPUT_UNWANTED - [0:0]
:INPUT_LIST - [0:0]
:REDIRECT_LIST - [0:0]
:REDIRECT_RULES - [0:0]
:REGION - [0:0]
:UNWANTED - [0:0]
:FORWARD_UNWANTED - [0:0]
:VIRUS - [0:0]
:SPAM - [0:0]
:WORM - [0:0]
:ABUSE - [0:0]
:COPYRIGHT - [0:0]
:WANTED - [0:0]
-A INPUT -i lo -j ACCEPT 
-A INPUT -d 224.0.0.0/8 -j ACCEPT    
-A INPUT -j ACCEPT -p icmp
-A INPUT -j ACCEPT -p tcp --dport 22
-A INPUT -j ACCEPT -p tcp --dport 10000
-A INPUT -j INPUT_LIST
';

print '-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT ';

print '
-A INPUT -j INPUT_UNWANTED
-A INPUT -j DROP 
-A FORWARD -j REDIRECT_LIST 
-A FORWARD -j VIRUS 
-A FORWARD -j REGION 
-A FORWARD -j FORWARD_UNWANTED 
-A FORWARD -j WANTED 
-A FORWARD -j UNWANTED 
-A FORWARD -j COUNTERS 
-A REDIRECT_RULES -p udp -m udp --dport 53 -j ACCEPT 
-A REDIRECT_RULES -p tcp -m tcp --dport 3129 -j ACCEPT 
-A REDIRECT_RULES -p tcp -m tcp --dport 3128 -j ACCEPT 
-A REDIRECT_RULES -p tcp -m tcp --dport 81 -j ACCEPT 
-A REDIRECT_RULES -p tcp -m tcp --dport 80 -j ACCEPT 
-A REDIRECT_RULES -j DROP 
-A UNWANTED -p tcp -m tcp --sport 139 -j DROP 
-A UNWANTED -p tcp -m tcp --sport 138 -j DROP 
-A UNWANTED -p tcp -m tcp --sport 137 -j DROP 
-A UNWANTED -p tcp -m tcp --sport 136 -j DROP 
-A UNWANTED -p tcp -m tcp --sport 135 -j DROP 
-A UNWANTED -p tcp -m tcp --sport 25 -j DROP 
-A UNWANTED -p tcp -m tcp --dport 25 -j DROP 
-A UNWANTED -p tcp -m tcp --dport 139 -j DROP 
-A UNWANTED -p tcp -m tcp --dport 138 -j DROP 
-A UNWANTED -p tcp -m tcp --dport 137 -j DROP 
-A UNWANTED -p tcp -m tcp --dport 136 -j DROP 
-A UNWANTED -p tcp -m tcp --dport 135 -j DROP
-A WORM -j ACCEPT -p udp --dport 53
-A SPAM -j DROP
-A COPYRIGHT -j ACCEPT -p udp --dport 53
-A COPYRIGHT -j DROP
-A ABUSE -j ACCEPT -p udp --dport 53
-A ABUSE -j DROP
';


foreach (sort { $a <=> $b } keys %Options::regional_rules)
{
    print "-A REGION $Options::regional_rules{$_}\n";
}



print '
-A WANTED -s 192.168.8.0/24 -j ACCEPT
-A WANTED -s 85.194.192.0/24 -j ACCEPT 
COMMIT
*nat
:PREROUTING ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:REDIRECT_LIST - [0:0]
:BLACKLIST - [0:0]
:NAT_REGION - [0:0]
-A PREROUTING -j REDIRECT_LIST
-A PREROUTING -j BLACKLIST 
-A POSTROUTING -j NAT_REGION 
';

foreach (sort { $a <=> $b } keys %Options::regional_nat_rules)
{
    print "-A NAT_REGION $Options::regional_nat_rules{$_} \n";
}

print 'COMMIT
# Completed on Wed Jan  5 21:15:52 2005 ';
